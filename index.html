<!DOCTYPE html>
<html>
<head>
    <title>Utica Cemetery Archive</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

    <style>
        body { margin:0; font-family: Georgia, serif; background:#111; }
        #map { height:100vh; width:100%; }

        /* SEARCH CONTAINER */
        #searchContainer {
            position:absolute;
            top:10px;
            left:50%;
            transform:translateX(-50%);
            z-index:1000;
            width:95%;
            max-width:750px;
        }

        #searchToggle {
            background:rgba(20,20,20,0.95);
            color:white;
            padding:8px;
            border-radius:6px;
            cursor:pointer;
            text-align:center;
        }

        #searchPanel {
            display:none;
            background:rgba(20,20,20,0.95);
            padding:10px;
            margin-top:5px;
            border-radius:6px;
            flex-wrap:wrap;
            gap:6px;
        }

        #searchPanel input {
            padding:6px;
            border:none;
            border-radius:4px;
            width:120px;
        }

        #searchPanel button {
            padding:6px 10px;
            border:none;
            border-radius:4px;
            cursor:pointer;
        }

        #noResults {
            position:absolute;
            top:120px;
            left:50%;
            transform:translateX(-50%);
            background:rgba(120,0,0,0.95);
            color:white;
            padding:8px 14px;
            border-radius:4px;
            display:none;
            z-index:1000;
        }

        .archive-popup { font-size:15px; line-height:1.4; }
        .person-card { margin-bottom:10px; }
        .divider { border-top:1px solid #ccc; margin:8px 0; }
        .stone-photo { width:100%; margin-top:8px; border-radius:4px; cursor:pointer; }

        /* FULLSCREEN IMAGE */
        #photoOverlay {
            display:none;
            position:fixed;
            z-index:2000;
            top:0;
            left:0;
            width:100%;
            height:100%;
            background:rgba(0,0,0,0.92);
            justify-content:center;
            align-items:center;
        }

        #photoContent {
            position:relative;
            max-width:95%;
            max-height:95%;
            text-align:center;
            color:white;
        }

        #overlayImage {
            max-width:100%;
            max-height:80vh;
            border-radius:6px;
        }

        #overlayCaption {
            margin-top:12px;
            font-size:18px;
        }

        #closeOverlay {
            position:absolute;
            top:-10px;
            right:-10px;
            font-size:32px;
            cursor:pointer;
        }
    </style>
</head>
<body>

<div id="searchContainer">
    <div id="searchToggle">Search ▾</div>

    <div id="searchPanel">
        <input type="text" id="firstNameSearch" placeholder="First Name">
        <input type="text" id="lastNameSearch" placeholder="Last Name">
        <input type="text" id="birthSearch" placeholder="Birth Year">
        <input type="text" id="deathSearch" placeholder="Death Year">
        <button id="clearBtn">Clear</button>
    </div>
</div>

<div id="noResults">No results found</div>

<div id="map"></div>

<!-- FULLSCREEN PHOTO -->
<div id="photoOverlay">
  <div id="photoContent">
    <span id="closeOverlay">&times;</span>
    <img id="overlayImage" src="">
    <div id="overlayCaption"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>

/* MAP INIT */
const map = L.map('map', { maxZoom:19, minZoom:16 })
.setView([39.736500, -93.636222], 18);

L.tileLayer(
'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
{ attribution:'Tiles © Esri', maxZoom:19 }
).addTo(map);

let markerIndex = [];
let allMarkers = [];

/* COLLAPSE TOGGLE */
const toggle = document.getElementById("searchToggle");
const panel = document.getElementById("searchPanel");

toggle.onclick = function() {
    if (panel.style.display === "none") {
        panel.style.display = "flex";
        toggle.innerText = "Search ▴";
    } else {
        panel.style.display = "none";
        toggle.innerText = "Search ▾";
    }
};

/* FULLSCREEN IMAGE */
function openPhoto(src, captionText) {
    document.getElementById("overlayImage").src = src;
    document.getElementById("overlayCaption").innerHTML = captionText;
    document.getElementById("photoOverlay").style.display = "flex";
}

document.getElementById("closeOverlay").onclick = function() {
    document.getElementById("photoOverlay").style.display = "none";
};

document.getElementById("photoOverlay").onclick = function(e) {
    if (e.target.id === "photoOverlay") {
        document.getElementById("photoOverlay").style.display = "none";
    }
};

/* SEARCH FUNCTION */
function runSearch() {

    const first = document.getElementById("firstNameSearch").value.toLowerCase();
    const last = document.getElementById("lastNameSearch").value.toLowerCase();
    const birth = document.getElementById("birthSearch").value;
    const death = document.getElementById("deathSearch").value;

    allMarkers.forEach(m => map.removeLayer(m));

    let matches = [];

    markerIndex.forEach(entry => {

        const p = entry.personData;
        let match = true;

        if (first && !p.first.toLowerCase().includes(first)) match = false;
        if (last && !p.last.toLowerCase().includes(last)) match = false;
        if (birth && !p.birth.includes(birth)) match = false;
        if (death && !p.death.includes(death)) match = false;

        if (match) matches.push(entry.marker);
    });

    matches = [...new Set(matches)];

    if ((first || last || birth || death) && matches.length === 0) {
        document.getElementById("noResults").style.display = "block";
        return;
    }

    document.getElementById("noResults").style.display = "none";

    matches.forEach(m => map.addLayer(m));

    if (matches.length === 1) {
        map.setView(matches[0].getLatLng(), 19);
        matches[0].openPopup();
    } else if (matches.length > 1) {
        const group = new L.featureGroup(matches);
        map.fitBounds(group.getBounds().pad(0.5));
    }
}

/* LIVE FILTER */
["firstNameSearch","lastNameSearch","birthSearch","deathSearch"]
.forEach(id => {
    document.getElementById(id).addEventListener("input", runSearch);
});

/* CLEAR */
document.getElementById("clearBtn").onclick = function() {
    ["firstNameSearch","lastNameSearch","birthSearch","deathSearch"]
    .forEach(id => document.getElementById(id).value = "");

    document.getElementById("noResults").style.display = "none";
    allMarkers.forEach(m => map.addLayer(m));
};

/* LOAD GOOGLE SHEET */
fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vS0fmOFHETJvNAEhdzwc_kaN2pk76rkVZ78f8woDAo2pHGo0bzZcgoPyQHQc2mo72_hTxDHihkW3KoS/pub?output=csv')
.then(res => res.text())
.then(csv => {

    const lines = csv.trim().split('\n');
    const headers = lines[0].split(',');
    const getIndex = name => headers.indexOf(name);

    const stones = {};

    for (let i=1; i<lines.length; i++) {

        if (!lines[i].trim()) continue;
        const cols = lines[i].split(',');

        const id = cols[getIndex("StoneID")];
        const lat = parseFloat(cols[getIndex("Latitude")]);
        const lng = parseFloat(cols[getIndex("Longitude")]);
        const first = cols[getIndex("FirstName")] || "";
        const last = cols[getIndex("LastName")] || "";
        const birth = cols[getIndex("BirthDate")] || "";
        const death = cols[getIndex("DeathDate")] || "";
        const photo = cols[getIndex("PhotoFileName")] || "";

        if (!id || isNaN(lat) || isNaN(lng)) continue;

        if (!stones[id]) stones[id] = { lat, lng, people: [], photo };

        stones[id].people.push({
            first, last,
            name:(first+" "+last).trim(),
            birth, death
        });
    }

    Object.values(stones).forEach(stone => {

        const marker = L.circleMarker([stone.lat, stone.lng], {
            radius:4,
            fillColor:"#fff",
            color:"#000",
            weight:1,
            fillOpacity:0.95
        }).addTo(map);

        allMarkers.push(marker);

        let popup = `<div class="archive-popup">`;

        stone.people.forEach((p,index)=>{

            popup += `
                <div class="person-card">
                    <strong>${p.name}</strong><br>
                    ${p.birth ? "Born: "+p.birth+"<br>" : ""}
                    ${p.death ? "Died: "+p.death+"<br>" : ""}
                </div>
            `;

            if(index < stone.people.length-1)
                popup += `<div class="divider"></div>`;

            markerIndex.push({ marker, personData:p });
        });

        if(stone.photo){
            const caption = stone.people.map(p =>
                `<strong>${p.name}</strong><br>${p.birth||""} – ${p.death||""}`
            ).join("<br><br>");

            popup += `
                <img src="photos/${stone.photo}" class="stone-photo"
                onclick="openPhoto('photos/${stone.photo}', \`${caption}\`)"
                onerror="this.style.display='none'">
                <div style="text-align:center;font-size:14px;margin-top:4px;">
                    Tap image to enlarge
                </div>
            `;
        }

        popup += `</div>`;
        marker.bindPopup(popup);

    });

});

</script>
</body>
</html>
