<!DOCTYPE html>
<html>
<head>
    <title>Utica Cemetery Archive</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

    <style>
        body { margin:0; font-family: Georgia, serif; background:#111; }
        #map { height:100vh; width:100%; }

        #searchContainer {
            position:absolute;
            top:10px;
            left:50%;
            transform:translateX(-50%);
            z-index:1000;
            width:95%;
            max-width:700px;
        }

        #searchToggle {
            background:rgba(20,20,20,0.95);
            color:white;
            padding:8px;
            border-radius:6px;
            cursor:pointer;
            text-align:center;
        }

        #searchPanel {
            display:none;
            background:rgba(20,20,20,0.95);
            padding:10px;
            margin-top:5px;
            border-radius:6px;
            flex-wrap:wrap;
            gap:6px;
        }

        #searchPanel input {
            padding:6px;
            border:none;
            border-radius:4px;
            width:120px;
        }

        #searchPanel button {
            padding:6px 10px;
            border:none;
            border-radius:4px;
            cursor:pointer;
        }

        #noResults {
            position:absolute;
            top:120px;
            left:50%;
            transform:translateX(-50%);
            background:rgba(120,0,0,0.95);
            color:white;
            padding:8px 14px;
            border-radius:4px;
            display:none;
            z-index:1000;
        }
    </style>
</head>
<body>

<div id="searchContainer">
    <div id="searchToggle">Search ▾</div>

    <div id="searchPanel">
        <input type="text" id="firstNameSearch" placeholder="First Name">
        <input type="text" id="lastNameSearch" placeholder="Last Name">
        <input type="text" id="birthSearch" placeholder="Birth Year">
        <input type="text" id="deathSearch" placeholder="Death Year">
        <button id="clearBtn">Clear</button>
    </div>
</div>

<div id="noResults">No results found</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>

/* MAP INIT */
const map = L.map('map', { maxZoom:19, minZoom:16 })
.setView([39.736500, -93.636222], 18);

L.tileLayer(
'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
{ attribution:'Tiles © Esri', maxZoom:19 }
).addTo(map);

let markerIndex = [];
let allMarkers = [];

/* COLLAPSE TOGGLE */
const toggle = document.getElementById("searchToggle");
const panel = document.getElementById("searchPanel");

toggle.onclick = function() {
    if (panel.style.display === "none") {
        panel.style.display = "flex";
        toggle.innerText = "Search ▴";
    } else {
        panel.style.display = "none";
        toggle.innerText = "Search ▾";
    }
};

/* SEARCH FUNCTION */
function runSearch() {

    const first = document.getElementById("firstNameSearch").value.toLowerCase();
    const last = document.getElementById("lastNameSearch").value.toLowerCase();
    const birth = document.getElementById("birthSearch").value;
    const death = document.getElementById("deathSearch").value;

    allMarkers.forEach(m => map.removeLayer(m));

    let matches = [];

    markerIndex.forEach(entry => {

        const p = entry.personData;
        let match = true;

        if (first && !p.first.toLowerCase().includes(first)) match = false;
        if (last && !p.last.toLowerCase().includes(last)) match = false;
        if (birth && !p.birth.includes(birth)) match = false;
        if (death && !p.death.includes(death)) match = false;

        if (match) matches.push(entry.marker);
    });

    matches = [...new Set(matches)];

    if ((first || last || birth || death) && matches.length === 0) {
        document.getElementById("noResults").style.display = "block";
        return;
    }

    document.getElementById("noResults").style.display = "none";

    matches.forEach(m => map.addLayer(m));

    if (matches.length === 1) {
        map.setView(matches[0].getLatLng(), 19);
        matches[0].openPopup();
    } else if (matches.length > 1) {
        const group = new L.featureGroup(matches);
        map.fitBounds(group.getBounds().pad(0.5));
    }
}

/* LIVE FILTER */
["firstNameSearch","lastNameSearch","birthSearch","deathSearch"]
.forEach(id => {
    document.getElementById(id).addEventListener("input", runSearch);
});

/* CLEAR */
document.getElementById("clearBtn").onclick = function() {
    ["firstNameSearch","lastNameSearch","birthSearch","deathSearch"]
    .forEach(id => document.getElementById(id).value = "");

    document.getElementById("noResults").style.display = "none";
    allMarkers.forEach(m => map.addLayer(m));
};

/* LOAD GOOGLE SHEET */
fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vS0fmOFHETJvNAEhdzwc_kaN2pk76rkVZ78f8woDAo2pHGo0bzZcgoPyQHQc2mo72_hTxDHihkW3KoS/pub?output=csv')
.then(res => res.text())
.then(csv => {

    const lines = csv.trim().split('\n');
    const headers = lines[0].split(',');
    const getIndex = name => headers.indexOf(name);

    const stones = {};

    for (let i=1; i<lines.length; i++) {

        if (!lines[i].trim()) continue;
        const cols = lines[i].split(',');

        const id = cols[getIndex("StoneID")];
        const lat = parseFloat(cols[getIndex("Latitude")]);
        const lng = parseFloat(cols[getIndex("Longitude")]);
        const first = cols[getIndex("FirstName")] || "";
        const last = cols[getIndex("LastName")] || "";
        const birth = cols[getIndex("BirthDate")] || "";
        const death = cols[getIndex("DeathDate")] || "";

        if (!id || isNaN(lat) || isNaN(lng)) continue;

        if (!stones[id]) stones[id] = {lat,lng,people:[]};

        stones[id].people.push({first,last,birth,death});
    }

    Object.values(stones).forEach(stone => {

        const marker = L.circleMarker([stone.lat, stone.lng], {
            radius:4,
            fillColor:"#fff",
            color:"#000",
            weight:1,
            fillOpacity:0.95
        }).addTo(map);

        allMarkers.push(marker);

        stone.people.forEach(p=>{
            markerIndex.push({marker, personData:p});
        });
    });

})
.catch(err => {
    console.error("CSV Load Error:", err);
});

</script>
</body>
</html>
